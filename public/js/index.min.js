"use strict";angular.module("mainApp",["ui.router","ngMaterial","ngMessages","ngAnimate","ngAria"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("landingpage",{url:"/landing",templateUrl:"../app/views/landing.html",controller:"homeCtrl"}).state("nav.documents",{url:"/userdocuments",templateUrl:"../app/views/document.html",controller:"docCtrl"}).state("nav",{url:"/nav",templateUrl:"../app/views/navbar.html",controller:"homeCtrl"}).state("signup",{url:"/signup",templateUrl:"../app/views/signUp.html",controller:"homeCtrl"}).state("nav.editDocument",{url:"/document/:id",templateUrl:"../app/views/editDocument.html",controller:"docCtrl"}).state("nav.docDetails",{url:"/more-doc-details/:id",templateUrl:"../app/views/documentDetails.html",controller:"docCtrl"}).state("nav.createdocument",{url:"/documents",templateUrl:"../app/views/newDocument.html",controller:"docCtrl"}).state("nav.userprofile",{url:"/user/:id",templateUrl:"../app/views/userprofile.html",controller:"userCtrl"}),t.otherwise("/landing")}]),angular.module("mainApp").controller("docCtrl",["$scope","$rootScope","$mdBottomSheet","$mdDialog","$state","$window","$stateParams","UserService","DocumentService","$location",function(e,t,o,n,r,a,u,s,c,l){e.getDocuments=function(){s.decodeUser(),s.getUserDocuments(t.userId).then(function(t){e.userDocs=t.data})},e.getCurrentDocument=function(e){r.go("nav.editDocument",{id:e._id})},e.getDocDetails=function(e){r.go("nav.docDetails",{id:e._id})},e.showDocDetails=function(){c.getDocumentById(u.id).then(function(t){e.doc=t.data[0]})},e.createDocument=function(t){e.docCreated=!1,c.createDocument(t).then(function(){e.docCreated=!0,l.url("/nav/userdocuments")})},e.logout=function(){localStorage.removeItem("userToken"),l.url("/landing")},e.deleteDocument=function(o){c.deleteDocument(o).then(function(o){e.docDeleted=o.data,s.getUserDocuments(t.userId).then(function(t){e.userDocs=t.data})})},e.updateDocument=function(t,o){e.docUpdated=!1,c.updateDocument(t,o).then(function(t){t?(e.docUpdated=!0,e.docInfo=t,l.url("/nav/userdocuments")):e.docUpdated=!1})},e.showConfirm=function(t,o){var r=n.confirm().title("Delete Document").content("Are you sure you want to delete this document?.").ariaLabel("Lucky day").targetEvent(t).ok("Yes!").cancel("No");n.show(r).then(function(){e.deleteDocument(o)})}}]),angular.module("mainApp").controller("homeCtrl",["$scope","$location","$mdToast","$stateParams","DocumentService","UserService",function(e,t,o,n,r,a){e.loginUser=function(n){a.login(n).then(function(r){e.progressLoad=!0,e.isLoggedIn=!1,"authentication failed, user not found"===r.data.message?(o.show(o.simple().content("Username or password mismatch").hideDelay(3e3)),e.progressLoad=!1,e.isLoggedIn=!1):"authentication failed, wrong password"===r.data.message?(o.show(o.simple().content("Username or password mismatch").hideDelay(3e3)),e.progressLoad=!1,e.isLoggedIn=!1):(localStorage.setItem("userToken",r.data.token),localStorage.getItem("userToken")&&(e.userDetails=n,e.response=r,e.progressLoad=!1,e.isLoggedIn=!0,e.userInformation=r.data.user,t.url("/nav/userdocuments")))})},e.logout=function(){e.isLoggedIn=!0,localStorage.removeItem("userToken"),localStorage.getItem("userToken")?e.isLoggedIn=!0:(e.isLoggedIn=!1,t.url("/landing"))},e.signupUser=function(t){e.progressLoad=!0,e.isNewUser=!1,a.createUser(t).then(function(n){"user name taken"===n.data.message?o.show(o.simple().content("Username already exists").hideDelay(3e3)):"Check parameters!"===n.data.message?o.show(o.simple().content("Invalid email format").hideDelay(3e3)):(e.userDetails=n,e.progressLoad=!1,e.isNewUser=!0,o.show(o.simple().content("Welcome to DMS!").hideDelay(3e3)),e.loginUser({username:t.username,password:t.password}))})}}]),angular.module("mainApp").controller("userCtrl",["$scope","$stateParams","$window","$mdDialog","$rootScope","$location","UserService",function(e,t,o,n,r,a,u){e.getUser=function(t){e.userCount=0,u.getCurrentUser(t).then(function(t){t&&(e.userCount=1,e.user=t.data[0])})},e.logout=function(){localStorage.removeItem("userToken"),a.url("/landing")},e.updateProfile=function(t,o){e.userUpdated=!1,u.updateUser(t,o).then(function(t){t?(e.updatedUser=t,e.userUpdated=!0,a.url("/nav/userdocuments")):e.userUpdated=!1})},e.deleteAccount=function(t){e.deleted=!1,u.deleteUser(t).then(function(t){e.deleted=!0,e.response=t.data,localStorage.removeItem("userToken"),a.url("/landing")})},e.showConfirmDelete=function(t,o){var r=n.confirm().title("Deactivate Account").content("Are you sure you want to deactivate your account.").ariaLabel("Lucky day").targetEvent(t).ok("Yes!").cancel("No");n.show(r).then(function(){e.deleteAccount(o)})}}]),angular.module("mainApp").factory("DocumentService",["$http",function(e){return{getAllDocuments:function(){return e.get("/api/documents")},createDocument:function(t){var o=localStorage.getItem("userToken");return e.post("/api/documents?token="+o,t)},deleteDocument:function(t){return e["delete"]("/api/document/"+t)},updateDocument:function(t,o){var n=localStorage.getItem("userToken");return e.put("/api/document/"+o+"?token="+n,t)},getDocumentById:function(t){return e.get("/api/document/"+t)}}}]),angular.module("mainApp").factory("UserService",["$http","$rootScope",function(e,t){function o(e){var t=e.replace("-","+").replace("_","/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}return window.atob(t)}return{getAllUsers:function(){return e.get("/api/users")},login:function(t){return e.post("/api/user/login",t)},createUser:function(t){return e.post("/api/users",t)},decodeUser:function(){if(localStorage.getItem("userToken")){var e=localStorage.getItem("userToken"),n={};if(e){var r=e.split(".")[1];n=JSON.parse(o(r)),t.userId=n._id}}},deleteUser:function(t){var o=localStorage.getItem("userToken");return e["delete"]("/api/user/"+t+"?token="+o)},updateUser:function(t,o){var n=localStorage.getItem("userToken");return e.put("/api/user/"+o+"?token="+n,t)},getUserDocuments:function(t){return e.get("/api/user/"+t+"/documents")},getCurrentUser:function(t){var o=localStorage.getItem("userToken");return e.get("/api/user/"+t+"?token="+o)}}}]);